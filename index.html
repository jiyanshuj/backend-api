<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WanderEase - Discover & Connect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #8b5cf6;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --dark: #1f2937; --gray: #6b7280; --light: #f3f4f6; --white: #fff;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--light); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 15px; position: sticky; top: 0; z-index: 100; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.3rem; }
        .header p { font-size: 0.75rem; opacity: 0.9; }
        .loc-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .user-row { display: flex; gap: 8px; margin-top: 10px; }
        .user-row input { flex: 1; padding: 9px 12px; border: none; border-radius: 8px; font-size: 0.85rem; }
        .user-row button { background: white; color: var(--primary); border: none; padding: 9px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }
        
        .tabs { display: flex; background: white; margin: 10px; border-radius: 10px; padding: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 8px 4px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.7rem; color: var(--gray); }
        .tab.active { background: var(--primary); color: white; }
        .tab i { display: block; font-size: 1rem; margin-bottom: 3px; }
        
        .content { padding: 0 10px 85px; }
        .section { display: none; }
        .section.active { display: block; }
        
        #mapBox { height: 55vh; border-radius: 14px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); }
        #mainMap { height: 100%; width: 100%; }
        
        .legend { background: white; padding: 10px 12px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .legend h4 { font-size: 0.75rem; color: var(--dark); margin-bottom: 8px; }
        .legend-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .leg-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: var(--gray); }
        .leg-dot { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        
        .place-filters { display: flex; gap: 6px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .place-filters::-webkit-scrollbar { display: none; }
        .pf-btn { padding: 6px 12px; border-radius: 16px; background: white; border: 1px solid var(--light); font-size: 0.7rem; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
        .pf-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .pf-btn i { font-size: 0.8rem; }
        
        .card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .card-head { display: flex; align-items: center; gap: 10px; }
        .card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
        .card-info { flex: 1; min-width: 0; }
        .card-info h3 { font-size: 0.9rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-info p { font-size: 0.7rem; color: var(--gray); }
        .card-meta { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .card-meta span { font-size: 0.65rem; color: var(--gray); display: flex; align-items: center; gap: 3px; }
        
        .badge { padding: 2px 7px; border-radius: 12px; font-size: 0.6rem; font-weight: 600; }
        .badge-user { background: #dbeafe; color: #1e40af; }
        .badge-place { background: #fef3c7; color: #92400e; }
        
        .btn { padding: 7px 14px; border-radius: 8px; font-weight: 600; font-size: 0.75rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 4px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }
        .btn-block { width: 100%; justify-content: center; }
        
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--dark); margin-bottom: 5px; }
        .form-control { width: 100%; padding: 9px 11px; border: 2px solid var(--light); border-radius: 8px; font-size: 0.8rem; }
        .form-control:focus { outline: none; border-color: var(--primary); }
        
        .act-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px; }
        .act-item { background: white; border: 2px solid transparent; border-radius: 10px; padding: 10px 6px; text-align: center; cursor: pointer; }
        .act-item:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .act-item.selected { border-color: var(--primary); background: #eef2ff; }
        .act-item i { font-size: 1.2rem; margin-bottom: 4px; display: block; }
        .act-item span { font-size: 0.65rem; color: var(--dark); }
        
        .mood-row { display: flex; flex-wrap: wrap; gap: 5px; }
        .mood-btn { padding: 5px 10px; border-radius: 12px; background: var(--light); color: var(--gray); font-size: 0.7rem; cursor: pointer; }
        .mood-btn.selected { background: var(--primary); color: white; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-box { background: white; width: 100%; max-height: 80vh; border-radius: 16px 16px 0 0; padding: 16px; overflow-y: auto; animation: slideUp 0.25s; }
        @keyframes slideUp { from { transform: translateY(100%); } }
        .modal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .modal-top h2 { font-size: 1rem; }
        .modal-close { width: 28px; height: 28px; border-radius: 50%; background: var(--light); border: none; cursor: pointer; font-size: 1rem; }
        
        .fab { position: fixed; bottom: 70px; right: 12px; width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; font-size: 1.2rem; cursor: pointer; box-shadow: 0 3px 12px rgba(99,102,241,0.4); z-index: 99; }
        
        .empty { text-align: center; padding: 25px 10px; color: var(--gray); }
        .empty i { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }
        .empty p { font-size: 0.8rem; }
        
        .loading { text-align: center; padding: 20px; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--light); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; z-index: 2000; }
        
        .list-container { max-height: 35vh; overflow-y: auto; }
        
        /* Chat styles */
        .chat-box { height: 220px; overflow-y: auto; border: 1px solid var(--light); border-radius: 10px; padding: 10px; margin-bottom: 10px; background: #fafafa; }
        .chat-msg { margin-bottom: 8px; }
        .chat-msg.sent { text-align: right; }
        .chat-bubble { display: inline-block; padding: 7px 11px; border-radius: 10px; max-width: 80%; font-size: 0.8rem; }
        .chat-msg.received .chat-bubble { background: white; border: 1px solid var(--light); }
        .chat-msg.sent .chat-bubble { background: var(--primary); color: white; }
        .chat-input { display: flex; gap: 6px; }
        
        .conn-row { display: flex; align-items: center; gap: 8px; }
        .conn-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8rem; }
        .conn-info { flex: 1; }
        .conn-info h4 { font-size: 0.85rem; }
        .conn-info p { font-size: 0.7rem; color: var(--gray); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-row">
            <div><h1>üß≠ WanderEase</h1><p>Discover places & connect with people</p></div>
            <button class="loc-btn" onclick="refreshLoc()"><i class="fas fa-crosshairs"></i></button>
        </div>
        <div class="user-row">
            <input type="text" id="userId" placeholder="Your User ID" value="user123">
            <button onclick="setUser()"><i class="fas fa-check"></i> Set</button>
        </div>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="discover"><i class="fas fa-map-marked-alt"></i>Discover</div>
        <div class="tab" data-tab="activities"><i class="fas fa-users"></i>Activities</div>
        <div class="tab" data-tab="connections"><i class="fas fa-comments"></i>Chats</div>
    </div>
    
    <div class="content">
        <!-- DISCOVER TAB -->
        <section id="discover" class="section active">
            <div class="place-filters">
                <div class="pf-btn active" data-type="all" onclick="filterPlaces('all',this)"><i class="fas fa-globe"></i> All</div>
                <div class="pf-btn" data-type="tourism" onclick="filterPlaces('tourism',this)"><i class="fas fa-landmark"></i> Tourism</div>
                <div class="pf-btn" data-type="restaurant" onclick="filterPlaces('restaurant',this)"><i class="fas fa-utensils"></i> Restaurant</div>
                <div class="pf-btn" data-type="hotel" onclick="filterPlaces('hotel',this)"><i class="fas fa-hotel"></i> Hotel</div>
                <div class="pf-btn" data-type="cafe" onclick="filterPlaces('cafe',this)"><i class="fas fa-mug-hot"></i> Cafe</div>
            </div>
            
            <div id="mapBox"><div id="mainMap"></div></div>
            
            <div class="legend">
                <h4>üó∫Ô∏è Map Legend</h4>
                <div class="legend-grid">
                    <div class="leg-item"><div class="leg-dot" style="background:#E91E63">üìç</div>You</div>
                    <div class="leg-item"><div class="leg-dot" style="background:#9C27B0">üèõÔ∏è</div>Tourism</div>
                    <div class="leg-item"><div class="leg-dot" style="background:#FF5722">üçΩÔ∏è</div>Restaurant</div>
                    <div class="leg-item"><div class="leg-dot" style="background:#00BCD4">üè®</div>Hotel</div>
                    <div class="leg-item"><div class="leg-dot" style="background:#8D6E63">‚òï</div>Cafe</div>
                    <div class="leg-item"><div class="leg-dot" style="background:#4CAF50">üë§</div>User Activity</div>
                </div>
            </div>
            
            <h4 style="font-size:0.8rem;margin-bottom:8px;color:var(--dark)">Nearby Places & People</h4>
            <div class="list-container" id="placesList">
                <div class="loading"><div class="spinner"></div><p style="font-size:0.8rem">Loading...</p></div>
            </div>
        </section>
        
        <!-- ACTIVITIES TAB -->
        <section id="activities" class="section">
            <h4 style="font-size:0.8rem;margin-bottom:8px;color:var(--dark)">My Activities</h4>
            <div id="myActivities"></div>
        </section>
        
        <!-- CONNECTIONS TAB -->
        <section id="connections" class="section">
            <h4 style="font-size:0.8rem;margin-bottom:8px;color:var(--dark)">Pending Requests</h4>
            <div id="pendingReqs"></div>
            <h4 style="font-size:0.8rem;margin:12px 0 8px;color:var(--dark)">Active Chats</h4>
            <div id="activeChats"></div>
        </section>
    </div>
    
    <button class="fab" onclick="openCreate()"><i class="fas fa-plus"></i></button>
    
    <!-- CREATE MODAL -->
    <div class="modal" id="createModal">
        <div class="modal-box">
            <div class="modal-top">
                <h2>Create Activity</h2>
                <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>What are you doing?</label>
                <div class="act-grid" id="actTypes"></div>
            </div>
            <div class="form-group">
                <label>Place Name</label>
                <input type="text" class="form-control" id="placeName" placeholder="e.g., Starbucks Central">
            </div>
            <div class="form-group">
                <label>Mood</label>
                <div class="mood-row" id="moodBtns"></div>
            </div>
            <div class="form-group">
                <label>Max Participants: <span id="maxVal">5</span></label>
                <input type="range" min="2" max="10" value="5" class="form-control" id="maxPart" oninput="document.getElementById('maxVal').textContent=this.value" style="padding:0">
            </div>
            <button class="btn btn-primary btn-block" onclick="createActivity()"><i class="fas fa-plus"></i> Create Activity</button>
        </div>
    </div>
    
    <!-- CHAT MODAL -->
    <div class="modal" id="chatModal">
        <div class="modal-box">
            <div class="modal-top">
                <h2 id="chatWith">Chat</h2>
                <button class="modal-close" onclick="closeModal('chatModal')">&times;</button>
            </div>
            <div class="chat-box" id="chatMsgs"></div>
            <div class="chat-input">
                <input type="text" class="form-control" id="msgInput" placeholder="Type message...">
                <button class="btn btn-primary" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = 'http://127.0.0.1:8000/api';
        let user = 'user123';
        let loc = { lat: 22.7196, lon: 75.8577 };
        let map, userMarker;
        let allMarkers = [];
        let allItems = [];
        let selType = null, selMood = 'casual', curConn = null;
        let currentFilter = 'all';
        
        const TYPES = {
            cafe: { icon: 'fa-mug-hot', emoji: '‚òï', label: 'Caf√©', color: '#8D6E63' },
            garden: { icon: 'fa-tree', emoji: 'üå≥', label: 'Park', color: '#4CAF50' },
            restaurant: { icon: 'fa-utensils', emoji: 'üçΩÔ∏è', label: 'Restaurant', color: '#FF5722' },
            mall: { icon: 'fa-bag-shopping', emoji: 'üõçÔ∏è', label: 'Mall', color: '#E91E63' },
            library: { icon: 'fa-book', emoji: 'üìö', label: 'Library', color: '#3F51B5' },
            movie: { icon: 'fa-film', emoji: 'üé¨', label: 'Movie', color: '#9C27B0' },
            gym: { icon: 'fa-dumbbell', emoji: 'üí™', label: 'Gym', color: '#F44336' },
            event: { icon: 'fa-calendar-star', emoji: 'üéâ', label: 'Event', color: '#FF9800' },
            coworking: { icon: 'fa-laptop', emoji: 'üíª', label: 'Co-work', color: '#00BCD4' },
            tourism: { icon: 'fa-landmark', emoji: 'üèõÔ∏è', label: 'Tourism', color: '#9C27B0' },
            hotel: { icon: 'fa-hotel', emoji: 'üè®', label: 'Hotel', color: '#00BCD4' }
        };
        const MOODS = ['chill', 'social', 'study', 'adventure', 'networking', 'casual'];
        
        document.addEventListener('DOMContentLoaded', () => {
            initUI();
            initMap();
            getLoc();
        });
        
        function initUI() {
            // Activity types for modal
            const actGrid = ['cafe','garden','restaurant','mall','library','movie','gym','event','coworking'];
            document.getElementById('actTypes').innerHTML = actGrid.map(k => {
                const t = TYPES[k];
                return `<div class="act-item" onclick="pickType('${k}',this)"><i class="fas ${t.icon}" style="color:${t.color}"></i><span>${t.label}</span></div>`;
            }).join('');
            
            // Mood buttons
            document.getElementById('moodBtns').innerHTML = MOODS.map(m => 
                `<div class="mood-btn ${m==='casual'?'selected':''}" onclick="pickMood('${m}',this)">${m}</div>`
            ).join('');
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    if (tab.dataset.tab === 'activities') loadMyActs();
                    if (tab.dataset.tab === 'connections') loadConns();
                    if (tab.dataset.tab === 'discover') setTimeout(() => map?.invalidateSize(), 100);
                };
            });
        }
        
        function initMap() {
            map = L.map('mainMap').setView([loc.lat, loc.lon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);
            userMarker = L.marker([loc.lat, loc.lon], {
                icon: L.divIcon({
                    html: '<div style="background:#E91E63;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:12px;">üìç</div>',
                    iconSize: [24, 24], className: ''
                })
            }).addTo(map).bindPopup('<b>You are here</b>');
        }
        
        function getLoc() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    loc = { lat: p.coords.latitude, lon: p.coords.longitude };
                    map.setView([loc.lat, loc.lon], 14);
                    userMarker.setLatLng([loc.lat, loc.lon]);
                    loadAll();
                }, () => loadAll());
            } else loadAll();
        }
        
        function refreshLoc() { toast('Refreshing...'); getLoc(); }
        function setUser() { user = document.getElementById('userId').value.trim() || 'user123'; toast('User: ' + user); loadAll(); }
        
        function pickType(t, el) {
            selType = t;
            document.querySelectorAll('.act-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }
        
        function pickMood(m, el) {
            selMood = m;
            document.querySelectorAll('.mood-btn').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }
        
        function filterPlaces(type, el) {
            currentFilter = type;
            document.querySelectorAll('.pf-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderList();
            renderMarkers();
        }
        
        // Load all data
        async function loadAll() {
            allItems = [];
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];
            
            document.getElementById('placesList').innerHTML = '<div class="loading"><div class="spinner"></div><p style="font-size:0.8rem">Loading nearby...</p></div>';
            
            try {
                // Fetch places from each category
                const placeTypes = ['tourism', 'restaurant', 'hotel', 'cafe'];
                for (const pType of placeTypes) {
                    try {
                        const res = await fetch(`${API}/${pType === 'cafe' ? 'restaurants' : pType === 'tourism' ? 'tourism' : pType + 's'}?location=${loc.lat},${loc.lon}&limit=10`);
                        const data = await res.json();
                        if (data.data) {
                            data.data.forEach(item => {
                                allItems.push({
                                    ...item,
                                    itemType: 'place',
                                    placeType: pType,
                                    lat: item.lat || loc.lat + (Math.random() - 0.5) * 0.02,
                                    lon: item.lon || loc.lon + (Math.random() - 0.5) * 0.02
                                });
                            });
                        }
                    } catch (e) { console.log(`Error loading ${pType}:`, e); }
                }
                
                // Fetch user activities
                const actRes = await fetch(`${API}/activities/nearby?lat=${loc.lat}&lon=${loc.lon}&radius_km=10&limit=20`);
                const actData = await actRes.json();
                if (actData.activities) {
                    actData.activities.forEach(act => {
                        allItems.push({
                            ...act,
                            itemType: 'activity',
                            placeType: act.activity_type
                        });
                    });
                }
                
                renderList();
                renderMarkers();
                
            } catch (err) {
                console.error(err);
                document.getElementById('placesList').innerHTML = '<div class="empty"><i class="fas fa-exclamation-circle"></i><p>Error loading data</p></div>';
            }
        }
        
        function renderList() {
            const container = document.getElementById('placesList');
            let filtered = allItems;
            
            if (currentFilter !== 'all') {
                filtered = allItems.filter(i => i.placeType === currentFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty"><i class="fas fa-map-marker-alt"></i><p>Nothing found nearby</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(item => {
                const t = TYPES[item.placeType] || TYPES.tourism;
                const isActivity = item.itemType === 'activity';
                
                return `
                    <div class="card">
                        <div class="card-head">
                            <div class="card-icon" style="background:${t.color}20"><span style="font-size:1.2rem">${t.emoji}</span></div>
                            <div class="card-info">
                                <h3>${item.name || item.place_name || t.label}</h3>
                                <p>${t.label}</p>
                            </div>
                            <span class="badge ${isActivity ? 'badge-user' : 'badge-place'}">${isActivity ? 'üë§ User' : 'üìç Place'}</span>
                        </div>
                        <div class="card-meta">
                            ${isActivity ? `
                                <span><i class="fas fa-users"></i> ${item.participant_count || 1}/${item.max_participants || 5}</span>
                                <span><i class="fas fa-heart"></i> ${item.mood || 'casual'}</span>
                            ` : `
                                <span><i class="fas fa-star"></i> ${item.rating || 'N/A'}</span>
                            `}
                            ${item.distance_km ? `<span><i class="fas fa-location-dot"></i> ${item.distance_km} km</span>` : ''}
                        </div>
                        ${isActivity && item.clerk_id !== user ? `
                            <div style="margin-top:8px">
                                <button class="btn btn-primary btn-sm" onclick="joinAct('${item.activity_id || item.id}')"><i class="fas fa-user-plus"></i> Join</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function renderMarkers() {
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];
            
            let filtered = allItems;
            if (currentFilter !== 'all') {
                filtered = allItems.filter(i => i.placeType === currentFilter);
            }
            
            filtered.forEach(item => {
                if (!item.lat || !item.lon) return;
                
                const t = TYPES[item.placeType] || TYPES.tourism;
                const isActivity = item.itemType === 'activity';
                
                const marker = L.marker([item.lat, item.lon], {
                    icon: L.divIcon({
                        html: `<div style="background:${isActivity ? '#4CAF50' : t.color};width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:14px;">${isActivity ? 'üë§' : t.emoji}</div>`,
                        iconSize: [32, 32],
                        className: ''
                    })
                }).addTo(map);
                
                const popupContent = `
                    <div style="min-width:150px">
                        <h4 style="margin:0 0 5px;font-size:13px;color:${t.color}">${item.name || item.place_name || t.label}</h4>
                        <p style="margin:2px 0;font-size:11px;color:#666">${t.label} ${isActivity ? '‚Ä¢ User Activity' : '‚Ä¢ Place'}</p>
                        ${isActivity ? `
                            <p style="margin:2px 0;font-size:11px"><i class="fas fa-users"></i> ${item.participant_count || 1}/${item.max_participants || 5}</p>
                            <p style="margin:2px 0;font-size:11px"><i class="fas fa-heart"></i> ${item.mood || 'casual'}</p>
                            ${item.clerk_id !== user ? `<button class="btn btn-primary btn-sm" style="margin-top:6px" onclick="joinAct('${item.activity_id || item.id}')">Join</button>` : ''}
                        ` : `
                            <p style="margin:2px 0;font-size:11px"><i class="fas fa-star"></i> ${item.rating || 'N/A'}</p>
                        `}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                allMarkers.push(marker);
            });
            
            // Fit bounds
            if (allMarkers.length > 0) {
                const group = new L.featureGroup([userMarker, ...allMarkers]);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Activity functions
        async function createActivity() {
            if (!selType) { toast('Select activity type'); return; }
            
            try {
                const res = await fetch(`${API}/activities?clerk_id=${user}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activity_type: selType,
                        lat: loc.lat,
                        lon: loc.lon,
                        place_name: document.getElementById('placeName').value,
                        mood: selMood,
                        max_participants: parseInt(document.getElementById('maxPart').value),
                        is_public: true
                    })
                });
                const data = await res.json();
                if (data.success) {
                    toast('Activity created!');
                    closeModal('createModal');
                    resetForm();
                    loadAll();
                } else toast(data.detail || 'Error');
            } catch (e) { toast('Error creating'); }
        }
        
        async function joinAct(id) {
            try {
                const res = await fetch(`${API}/activities/${id}/join?clerk_id=${user}`, { method: 'POST' });
                const data = await res.json();
                if (data.success) { toast('Joined!'); loadAll(); }
                else toast(data.detail || 'Cannot join');
            } catch (e) { toast('Error'); }
        }
        
        async function loadMyActs() {
            const container = document.getElementById('myActivities');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const res = await fetch(`${API}/activities/user/${user}`);
                const data = await res.json();
                if (data.activities?.length > 0) {
                    container.innerHTML = data.activities.map(a => {
                        const t = TYPES[a.activity_type] || TYPES.cafe;
                        return `
                            <div class="card">
                                <div class="card-head">
                                    <div class="card-icon" style="background:${t.color}20"><span style="font-size:1.2rem">${t.emoji}</span></div>
                                    <div class="card-info">
                                        <h3>${a.place_name || t.label}</h3>
                                        <p>${t.label}</p>
                                    </div>
                                    <span class="badge" style="background:#d1fae5;color:#065f46">${a.status || 'active'}</span>
                                </div>
                                <div class="card-meta">
                                    <span><i class="fas fa-users"></i> ${a.participant_count || 1}/${a.max_participants || 5}</span>
                                    <span><i class="fas fa-heart"></i> ${a.mood || 'casual'}</span>
                                </div>
                                <div style="margin-top:8px">
                                    <button class="btn btn-danger btn-sm" onclick="cancelAct('${a.activity_id || a.id}')"><i class="fas fa-times"></i> Cancel</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty"><i class="fas fa-calendar-plus"></i><p>No activities yet</p></div>';
                }
            } catch (e) {
                container.innerHTML = '<div class="empty"><i class="fas fa-exclamation-circle"></i><p>Error</p></div>';
            }
        }
        
        async function cancelAct(id) {
            if (!confirm('Cancel this activity?')) return;
            try {
                await fetch(`${API}/activities/${id}?clerk_id=${user}`, { method: 'DELETE' });
                toast('Cancelled');
                loadMyActs();
                loadAll();
            } catch (e) { toast('Error'); }
        }
        
        // Connections
        async function loadConns() {
            try {
                // Pending
                const pRes = await fetch(`${API}/connections/pending?clerk_id=${user}`);
                const pData = await pRes.json();
                document.getElementById('pendingReqs').innerHTML = pData.pending_requests?.length > 0
                    ? pData.pending_requests.map(c => connCard(c, true)).join('')
                    : '<div class="card"><p style="color:var(--gray);text-align:center;font-size:0.8rem">No pending</p></div>';
                
                // Active
                const aRes = await fetch(`${API}/connections?clerk_id=${user}&status=accepted`);
                const aData = await aRes.json();
                document.getElementById('activeChats').innerHTML = aData.connections?.length > 0
                    ? aData.connections.map(c => connCard(c, false)).join('')
                    : '<div class="card"><p style="color:var(--gray);text-align:center;font-size:0.8rem">No chats</p></div>';
            } catch (e) { console.error(e); }
        }
        
        function connCard(c, pending) {
            const other = c.from_clerk_id === user ? c.to_clerk_id : c.from_clerk_id;
            const init = other.substring(0, 2).toUpperCase();
            return `
                <div class="card">
                    <div class="conn-row">
                        <div class="conn-avatar">${init}</div>
                        <div class="conn-info"><h4>${other}</h4><p>Activity</p></div>
                        ${pending ? `
                            <button class="btn btn-success btn-sm" onclick="respond('${c.connection_id}',true)"><i class="fas fa-check"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="respond('${c.connection_id}',false)"><i class="fas fa-times"></i></button>
                        ` : `
                            <button class="btn btn-primary btn-sm" onclick="openChat('${c.connection_id}','${other}')"><i class="fas fa-comment"></i></button>
                        `}
                    </div>
                </div>
            `;
        }
        
        async function respond(id, accept) {
            try {
                await fetch(`${API}/connections/${id}/respond?clerk_id=${user}&accept=${accept}`, { method: 'POST' });
                toast(accept ? 'Accepted!' : 'Declined');
                loadConns();
            } catch (e) { toast('Error'); }
        }
        
        function openChat(id, name) {
            curConn = id;
            document.getElementById('chatWith').textContent = 'Chat: ' + name;
            document.getElementById('chatMsgs').innerHTML = '<p style="text-align:center;color:var(--gray);font-size:0.8rem">Start chatting!</p>';
            openModal('chatModal');
            loadChatMsgs(id);
        }
        
        async function loadChatMsgs(id) {
            try {
                const res = await fetch(`${API}/connections?clerk_id=${user}`);
                const data = await res.json();
                const c = data.connections?.find(x => x.connection_id === id);
                if (c?.messages?.length > 0) {
                    const box = document.getElementById('chatMsgs');
                    box.innerHTML = c.messages.map(m => 
                        `<div class="chat-msg ${m.sender_id === user ? 'sent' : 'received'}"><div class="chat-bubble">${m.message}</div></div>`
                    ).join('');
                    box.scrollTop = box.scrollHeight;
                }
            } catch (e) {}
        }
        
        async function sendMsg() {
            const input = document.getElementById('msgInput');
            const msg = input.value.trim();
            if (!msg || !curConn) return;
            
            try {
                const res = await fetch(`${API}/connections/${curConn}/message?clerk_id=${user}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                if (res.ok) {
                    input.value = '';
                    const box = document.getElementById('chatMsgs');
                    if (box.querySelector('p')) box.innerHTML = '';
                    box.innerHTML += `<div class="chat-msg sent"><div class="chat-bubble">${msg}</div></div>`;
                    box.scrollTop = box.scrollHeight;
                }
            } catch (e) { toast('Error'); }
        }
        
        // Helpers
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function openCreate() { resetForm(); openModal('createModal'); }
        
        function resetForm() {
            selType = null;
            selMood = 'casual';
            document.querySelectorAll('.act-item').forEach(e => e.classList.remove('selected'));
            document.querySelectorAll('.mood-btn').forEach(e => e.classList.toggle('selected', e.textContent === 'casual'));
            document.getElementById('placeName').value = '';
            document.getElementById('maxPart').value = 5;
            document.getElementById('maxVal').textContent = '5';
        }
        
        function toast(msg) {
            const old = document.querySelector('.toast');
            if (old) old.remove();
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }
        
        // Enter to send
        document.addEventListener('keypress', e => {
            if (e.key === 'Enter' && document.getElementById('chatModal').classList.contains('show')) sendMsg();
        });
    </script>
</body>
</html>